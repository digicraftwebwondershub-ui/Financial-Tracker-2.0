<script>
    // Global State
    let currentTab = 'dashboard';
    const tabDataLoaders = {
        'dashboard': loadDashboard,
        'transactions': loadTransactions,
        'creditCards': loadCreditCards,
        'savingsGoals': loadGoals,
        'reminders': loadReminders
    };
    const modalMap = {
        'addTransaction': '#addTransactionModal',
        'addGoal': '#addGoalModal',
        'addReminder': '#addReminderModal'
    };
    
    // --- Utility Functions ---

    /** Shows a spinner when a backend call is active. */
    function toggleLoading(show) {
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
            spinner.style.display = show ? 'inline-block' : 'none';
        }
    }
    
    /** Shows a toast notification/snackbar. */
    function showSnackbar(message, type = 'info') {
        const snackbar = document.getElementById('snackbar');
        snackbar.textContent = message;
        snackbar.className = `snackbar show bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
        setTimeout(() => { 
            snackbar.className = snackbar.className.replace("show", ""); 
        }, 3000);
    }

    /** Formats a number to currency (Philippine Peso). */
    function formatCurrency(number) {
        return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(number);
    }

    /** Formats a number to percentage. */
    function formatPercent(number) {
        return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 1 }).format(number);
    }

    // --- Core App Logic ---

    /** Switches the active tab in the UI. */
    function switchTab(tabId) {
        currentTab = tabId;
        // 1. Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        // 2. Show the active tab content
        document.getElementById(tabId).style.display = 'block';
        // 3. Update the main header title
        document.getElementById('page-title').textContent = document.querySelector(`a[data-tab="${tabId}"]`).textContent.trim();

        // 4. Update sidebar visual state
        document.querySelectorAll('#nav-tabs .nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector(`a[data-tab="${tabId}"]`).classList.add('active');

        // 5. Load data
        if (tabDataLoaders[tabId]) {
            tabDataLoaders[tabId]();
        }
    }
    
    // --- Data Loaders & Renderers ---

    function loadDashboard() {
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(renderDashboard)
            .withFailureHandler(e => { showSnackbar('Error loading dashboard: ' + e, 'error'); toggleLoading(false); })
            .getDashboardData();
    }

    function renderDashboard(data) {
        // 1. KPI Cards - New Structure
        const netIncomeCard = document.getElementById('net-income');
        netIncomeCard.querySelector('.card-value').textContent = formatCurrency(data.netIncome);

        const expensesCard = document.getElementById('total-expenses');
        expensesCard.querySelector('.card-value').textContent = formatCurrency(data.totalExpenses);

        const savingsCard = document.getElementById('savings-rate');
        savingsCard.querySelector('.card-value').textContent = formatPercent(data.savingsRate);

        const creditCard = document.getElementById('credit-usage');
        creditCard.querySelector('.card-value').textContent = formatPercent(data.creditUsage);
        creditCard.querySelector('.card-subtitle').textContent = `${formatCurrency(data.availableCredit)} available`;

        // 2. Microcopy
        document.getElementById('motivational-microcopy').textContent = data.motivationalMessage;

        // 3. Credit Card List
        const cardList = document.getElementById('card-list');
        cardList.innerHTML = '';
        if (data.cardStats.length === 0) {
            cardList.innerHTML = `<p class="text-muted">No credit cards added yet.</p>`;
        } else {
            data.cardStats.forEach(card => {
                const usagePercent = (card.usage * 100).toFixed(2);
                const item = `
                    <div class="credit-card-item mb-3">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">${card.name}</h6>
                            <span class="badge bg-dark usage-badge">${usagePercent}%</span>
                        </div>
                        <div class="d-flex justify-content-between text-muted small">
                            <span>Balance: <strong>${formatCurrency(card.balance)}</strong></span>
                            <span>Limit: ${formatCurrency(card.limit)}</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: ${usagePercent}%;" aria-valuenow="${usagePercent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between text-muted small mt-1">
                            <span>APR: ${(card.apr * 100).toFixed(2)}%</span>
                            <span>Due: ${new Date(card.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                        </div>
                    </div>`;
                cardList.innerHTML += item;
            });
        }

        // 4. Goals Progress List
        const goalsList = document.getElementById('goals-progress-list');
        goalsList.innerHTML = '';
        if (data.goalsProgress.length === 0) {
            goalsList.innerHTML = `<p class="text-muted">No savings goals set yet.</p>`;
        } else {
            data.goalsProgress.forEach(goal => {
                const progressPercent = (goal.progress * 100).toFixed(2);
                const item = `
                    <div class="goal-item mb-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-0">${goal.name}</h6>
                                <span class="small">${formatCurrency(goal.saved)}</span>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-dark usage-badge">${progressPercent}%</span>
                                <div class="small text-muted">${formatCurrency(goal.target)}</div>
                            </div>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%;" aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between text-muted small mt-1">
                            <span>${formatCurrency(goal.remaining)} remaining</span>
                            <span>Target: ${new Date(goal.targetDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                        </div>
                    </div>`;
                goalsList.innerHTML += item;
            });
        }

        toggleLoading(false);
    }

    // Generic Load and Render function
    function loadAndRender(loadFunction, renderFunction, sheetName, filters = {}) {
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(renderFunction)
            .withFailureHandler(e => { showSnackbar(`Error loading ${sheetName}: ` + e, 'error'); toggleLoading(false); })
            [loadFunction](filters);
    }

    function applyTransactionFilters() {
        const type = document.getElementById('filter-type').value;
        const category = document.getElementById('filter-category').value;
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        const filters = {
            type: type === 'All' ? null : type,
            category: category === 'All' ? null : category,
            startDate: startDate || null,
            endDate: endDate || null
        };
        loadTransactions(filters);
    }

    function loadTransactions(filters = {}) { 
        loadAndRender('loadTransactions', (data) => {
            populateCategoryFilter(data);
            renderTransactions(data);
        }, 'Transactions', filters); 
    }
    
    function populateCategoryFilter(transactions) {
        const categoryFilter = document.getElementById('filter-category');
        const existingValue = categoryFilter.value;
        
        // Extract unique categories, excluding any undefined/null ones
        const categories = [...new Set(transactions.map(t => t.CATEGORY).filter(Boolean))];
        categories.sort();

        // Clear existing options except for "All"
        while (categoryFilter.options.length > 1) {
            categoryFilter.remove(1);
        }

        // Add new options
        categories.forEach(cat => {
            const option = new Option(cat, cat);
            categoryFilter.add(option);
        });

        // Restore previous selection if it still exists
        categoryFilter.value = existingValue;
    }


    function getTransactionCardDetails(transaction) {
        let icon, color, note, title;
        const type = transaction.TYPE;
        const category = transaction.CATEGORY;
        const amount = transaction.AMOUNT || 0;

        title = `${type} - ${category}`;

        switch (type) {
            case 'Income':
                icon = 'fas fa-arrow-down';
                color = 'success';
                note = 'Income received. Well done!';
                break;
            case 'Expense':
                icon = 'fas fa-arrow-up';
                color = 'danger';
                note = 'Expense logged. Keep tracking to stay mindful!';
                break;
            case 'Transfer':
                icon = 'fas fa-exchange-alt';
                color = 'info';
                note = 'Transfer recorded.';
                break;
            default:
                icon = 'fas fa-dollar-sign';
                color = 'secondary';
                note = 'Transaction recorded.';
        }

        if (category === 'Savings Deposit') {
            icon = 'fas fa-piggy-bank';
            color = 'primary';
            title = `Savings - ${transaction.DESCRIPTION || 'Deposit'}`;
            note = `Great — you saved ${formatCurrency(amount)} today!`;
        }
        
        if (category === 'Salary') {
            note = `Payday! Your hard work is paying off.`;
        }

        return { icon, color, note, title };
    }

    function renderTransactions(data) {
        const container = document.getElementById('transaction-cards-container');
        container.innerHTML = '';
        
        if (data.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No transactions found for the selected period.</p></div>';
            toggleLoading(false);
            return;
        }
        
        data.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));

        data.forEach(t => {
            const { icon, color, note, title } = getTransactionCardDetails(t);
            const amount = t.AMOUNT || 0;
            const formattedAmount = formatCurrency(amount);

            const card = `
                <div class="col-lg-6 mb-4">
                    <div class="card transaction-card h-100">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-auto">
                                <div>
                                    <h5 class="card-title text-${color} mb-3"><i class="${icon} me-2"></i>${title}</h5>
                                    <p class="card-text mb-1"><strong>Date:</strong> ${new Date(t.DATE).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                                    <p class="card-text mb-1"><strong>Amount:</strong> <span class="fw-bold text-${color}">${formattedAmount}</span></p>
                                    <p class="card-text mb-1"><strong>Description:</strong> ${t.DESCRIPTION || 'N/A'}</p>
                                    <p class="card-text mb-1"><strong>Payment Method:</strong> ${t.PAYMENTMETHOD || 'N/A'}</p>
                                    <p class="card-text mb-0"><strong>Account:</strong> ${t.ACCOUNT || 'N/A'}</p>
                                </div>
                                <div class="transaction-actions">
                                    <button class="btn btn-sm btn-outline-secondary me-1" title="Edit" onclick="editTransaction('${t.TRANSACTION_ID}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="deleteTransaction('${t.TRANSACTION_ID}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-top">
                                <p class="card-text text-muted small fst-italic mb-0"><i class="fas fa-info-circle me-1"></i> ${note}</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            container.innerHTML += card;
        });
        
        toggleLoading(false);
    }
    
    function loadCreditCards() { loadAndRender('loadCreditCards', renderCreditCards, 'Credit Cards'); }

    function renderCreditCards(data) {
        const container = document.getElementById('credit-cards-container');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No credit cards added yet. Click "Add Credit Card" to get started.</p></div>';
            toggleLoading(false);
            return;
        }

        data.forEach(c => {
            const limit = c.LIMIT || 0;
            const balance = c.BALANCE || 0;
            const usage = limit > 0 ? (balance / limit) : 0;
            const usagePercent = Math.round(usage * 100);
            
            // Determine card border color
            let borderColorClass = 'border-primary'; // Default blue
            if (usage > 0.75) {
                borderColorClass = 'border-danger'; // High usage
            } else if (balance > 0 && usage <= 0.75) {
                borderColorClass = 'border-warning'; // Moderate usage with balance
            } else if (balance === 0) {
                borderColorClass = 'border-success'; // Paid off
            }

            // Determine dynamic note
            const dueDate = new Date(c.DUEDATE);
            const today = new Date();
            const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            let note = '';
            if (balance > 0 && daysUntilDue > 0) {
                note = `<p class="card-text small text-success mb-0"><i class="fas fa-check-circle me-1"></i> Your next bill is due in ${daysUntilDue} days — you've got this!</p>`;
            } else if (balance > 0 && daysUntilDue <= 0) {
                note = `<p class="card-text small text-danger mb-0"><i class="fas fa-exclamation-triangle me-1"></i> Your bill is overdue. Please make a payment.</p>`;
            } else {
                 note = `<p class="card-text small text-muted mb-0"><i class="fas fa-star me-1"></i> No missed payments this month. Keep your streak!</p>`;
            }

            const cardHtml = `
                <div class="col-lg-6">
                    <div class="card credit-card-widget ${borderColorClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">${c.CARDNAME} (${c.BANKNAME})</h5>
                                <span class="badge usage-badge-pill" style="background-color: ${borderColorClass.replace('border', 'bg')}">${usagePercent}%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <p class="card-text mb-2">Balance: <strong>${formatCurrency(balance)}</strong></p>
                                <p class="card-text text-muted">Limit: ${formatCurrency(limit)}</p>
                            </div>
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: ${usagePercent}%; background-color: ${borderColorClass.replace('border', 'var(--bs')});" aria-valuenow="${usagePercent}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="card-text small text-muted mb-2">
                                APR: ${(c.APR * 100).toFixed(3)}% | 
                                Due: ${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} | 
                                Statement: ${new Date(c.STATEMENTDATE).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </p>
                            ${note}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });

        toggleLoading(false);
    }

    function loadGoals() { loadAndRender('loadGoals', renderGoals, 'Goals'); }

    function renderGoals(data) {
        const container = document.getElementById('savings-goals-container');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No savings goals set yet. Click "Add Goal" to get started.</p></div>';
            toggleLoading(false);
            return;
        }

        const categoryColors = {
            'Emergency Fund': 'danger',
            'Down Payment': 'primary',
            'Vacation': 'info',
            'Investment': 'success',
            'Other': 'secondary'
        };

        data.forEach(g => {
            const target = g.TARGETAMOUNT || 0;
            const saved = g.SAVEDAMOUNT || 0;
            const progress = target > 0 ? (saved / target) : 0;
            const progressPercent = Math.round(progress * 100);
            const remaining = target - saved;
            const weeklySavings = g.weeklySavingsNeeded || 0;

            const categoryColor = categoryColors[g.CATEGORY] || 'secondary';
            let progressBarColor = 'bg-danger';
            if (progressPercent > 75) {
                progressBarColor = 'bg-success';
            } else if (progressPercent > 25) {
                progressBarColor = 'bg-warning';
            }

            const cardHtml = `
                <div class="col-lg-6">
                    <div class="card savings-goal-widget border-${categoryColor}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${g.GOALNAME}</h5>
                                    <span class="badge bg-${categoryColor}">${g.CATEGORY}</span>
                                </div>
                                <span class="badge bg-dark progress-badge">${progressPercent}%</span>
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <p class="card-text mb-0">Saved: <strong>${formatCurrency(saved)}</strong></p>
                                <p class="card-text text-muted">Target: ${formatCurrency(target)}</p>
                            </div>
                            <div class="progress mt-1 mb-3" style="height: 10px;">
                                <div class="progress-bar ${progressBarColor}" role="progressbar" style="width: ${progressPercent}%;" aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="card-text small text-muted">
                                ${formatCurrency(remaining)} remaining | Due: ${new Date(g.TARGETDATE).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </p>
                            <p class="card-text small text-warning"><i class="fas fa-lightbulb me-1"></i> Stay consistent! Saving ${formatCurrency(weeklySavings)} more this week gets you back on track.</p>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });

        toggleLoading(false);
    }
    
    function loadReminders() { loadAndRender('loadReminders', renderReminders, 'Reminders'); }
    function renderReminders(data) {
        const container = document.getElementById('reminders-container');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No payment reminders set up yet. Click "Add Reminder" to get started.</p></div>';
            toggleLoading(false);
            return;
        }

        data.sort((a, b) => new Date(a.DUEDATE) - new Date(b.DUEDATE));

        let cardsHtml = '';
        data.forEach(r => {
            const daysLeft = r.DAYSLEFT || 0;
            let status, borderColor, statusBadgeColor, note, noteIcon, actionButton;

            if (r.STATUS === 'Paid') {
                status = 'Paid';
                borderColor = 'border-success';
                statusBadgeColor = 'bg-success';
                note = `You paid your ${r.DESCRIPTION} on time — nice discipline!`;
                noteIcon = 'fas fa-check-square text-success';
                actionButton = '<button class="btn btn-secondary action-btn" disabled><i class="fas fa-history me-2"></i>Paid</button>';
            } else if (daysLeft < 0) {
                status = 'Pending';
                borderColor = 'border-danger';
                statusBadgeColor = 'bg-danger';
                note = `Overdue! Don't stress — mark it done once paid.`;
                noteIcon = 'fas fa-exclamation-circle text-danger';
                actionButton = `<button class="btn btn-danger action-btn" onclick="markReminderPaid('${r.REMINDER_ID}')"><i class="fas fa-check-circle me-2"></i>Mark as Paid</button>`;
            } else {
                status = 'Pending';
                borderColor = 'border-warning';
                statusBadgeColor = 'bg-warning text-dark';
                note = `Due in ${daysLeft} day(s). A friendly reminder to stay on top of your finances!`;
                noteIcon = 'fas fa-info-circle text-warning';
                actionButton = `<button class="btn btn-success action-btn" onclick="markReminderPaid('${r.REMINDER_ID}')"><i class="fas fa-check-circle me-2"></i>Mark as Paid</button>`;
            }

            const cardHtml = `
                <div class="col-lg-4 col-md-6">
                    <div class="card reminder-card ${borderColor}">
                        <div class="card-body">
                            <div>
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">${r.DESCRIPTION}</h5>
                                    <span class="badge status-badge ${statusBadgeColor}">${status}</span>
                                </div>
                                <p class="card-text mb-2">
                                    Amount: <strong>${formatCurrency(r.AMOUNT)}</strong>
                                </p>
                                <p class="text-muted small">
                                    Due: ${new Date(r.DUEDATE).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} | ${daysLeft} days left
                                </p>
                                <p class="reminder-note text-muted mt-3">
                                    <i class="${noteIcon} me-2"></i>${note}
                                </p>
                            </div>
                            <div class="mt-3 d-flex">
                                ${actionButton}
                                <button class="btn btn-sm btn-outline-secondary ms-2" title="Edit"><i class="fas fa-edit"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            cardsHtml += cardHtml;
        });

        container.innerHTML = cardsHtml;
        toggleLoading(false);
    }

    // --- Action Handlers (Forms & Buttons) ---

    /** Deletes a transaction after confirmation. */
    function deleteTransaction(transactionId) {
        if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
            return;
        }
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(result => {
                showSnackbar(result.message, result.status);
                applyTransactionFilters(); // Refresh the view
            })
            .withFailureHandler(e => { showSnackbar('Delete Error: ' + e, 'error'); toggleLoading(false); })
            .deleteRecord('Transactions', transactionId);
    }

    /** Populates the transaction modal for editing. */
    function editTransaction(transactionId) {
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(transaction => {
                // Populate the modal
                document.getElementById('edit-trans-id').value = transaction.TRANSACTION_ID;
                document.getElementById('edit-trans-date').value = new Date(transaction.DATE).toISOString().slice(0, 10);
                document.getElementById('edit-trans-type').value = transaction.TYPE;
                document.getElementById('edit-trans-category').value = transaction.CATEGORY;
                document.getElementById('edit-trans-amount').value = transaction.AMOUNT;
                document.getElementById('edit-trans-desc').value = transaction.DESCRIPTION;
                document.getElementById('edit-trans-method').value = transaction.PAYMENTMETHOD;
                document.getElementById('edit-trans-account').value = transaction.ACCOUNT;
                document.getElementById('edit-trans-related').value = transaction.RELATED_ID;

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
                modal.show();
                toggleLoading(false);
            })
            .withFailureHandler(e => { showSnackbar('Error fetching transaction: ' + e, 'error'); toggleLoading(false); })
            .getRecordById('Transactions', transactionId);
    }

    /** Special handler for marking a reminder as paid. */
    function markReminderPaid(reminderId) {
        if (!confirm('Are you sure you want to mark this reminder as paid and create a corresponding transaction?')) {
            return;
        }
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(result => {
                showSnackbar(result.message, result.status);
                loadReminders(); // Refresh the Reminders tab
                loadDashboard(); // Dashboard might be affected (e.g., Net Income)
            })
            .withFailureHandler(e => { showSnackbar('Payment Error: ' + e, 'error'); toggleLoading(false); })
            .markReminderPaid(reminderId, {}); // {} is a placeholder for potential form data
    }

    function handleEditTransactionSubmit(event) {
        event.preventDefault();
        toggleLoading(true);

        const form = event.target;
        const formData = {};
        new FormData(form).forEach((value, key) => {
            formData[key] = value;
        });
        const transactionId = formData['TRANSACTION_ID'];

        google.script.run
            .withSuccessHandler(result => {
                showSnackbar(result.message, result.status);
                const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                if (modal) modal.hide();
                applyTransactionFilters(); // Refresh the view
            })
            .withFailureHandler(e => { showSnackbar('Update Error: ' + e, 'error'); toggleLoading(false); })
            .updateRecord('Transactions', transactionId, formData);
    }

    /** Generic function to handle form submission for adding a new record. */
    function handleFormSubmission(event, sheetName, prefix) {
        event.preventDefault();
        toggleLoading(true);
        
        const form = event.target;
        const formData = {};
        new FormData(form).forEach((value, key) => {
            formData[key] = value;
        });
        
        google.script.run
            .withSuccessHandler(result => {
                showSnackbar(result.message, result.status);
                form.reset();
                // Close the modal
                const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                if (modal) modal.hide();
                
                // Refresh the relevant tab data
                if (currentTab in tabDataLoaders) {
                    tabDataLoaders[currentTab]();
                } else {
                    loadDashboard(); // Default refresh
                }
            })
            .withFailureHandler(e => { showSnackbar('Action Error: ' + e, 'error'); toggleLoading(false); })
            .addRecord(sheetName, formData, prefix);
    }

    /** Special handler for marking a reminder as paid. */
    function markReminderPaid(reminderId) {
        if (!confirm('Are you sure you want to mark this reminder as paid and create a corresponding transaction?')) {
            return;
        }
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(result => {
                showSnackbar(result.message, result.status);
                loadReminders(); // Refresh the Reminders tab
                loadDashboard(); // Dashboard might be affected (e.g., Net Income)
            })
            .withFailureHandler(e => { showSnackbar('Payment Error: ' + e, 'error'); toggleLoading(false); })
            .markReminderPaid(reminderId, {}); // {} is a placeholder for potential form data
    }
    
    /** Extra Feature: Export Data */
    function exportData(sheetName) {
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(base64Csv => {
                const link = document.createElement('a');
                link.href = 'data:text/csv;base64,' + base64Csv;
                link.download = `${sheetName}_export_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSnackbar('Data exported successfully!', 'success');
            })
            .withFailureHandler(e => { showSnackbar('Export Error: ' + e, 'error'); toggleLoading(false); })
            .exportToCSV(sheetName);
    }
    
    // --- Initialization ---
    
    document.addEventListener('DOMContentLoaded', () => {
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.checked = true;
        }
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
        });
        
       // Tab Navigation Listener
        document.querySelectorAll('#nav-tabs .nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(link.getAttribute('data-tab'));
                // Close mobile sidebar if open
                const sidebarCollapse = document.getElementById('sidebar');
                if (sidebarCollapse.classList.contains('show')) {
                const collapseInstance = bootstrap.Collapse.getInstance(sidebarCollapse);
                    if (collapseInstance) {
                         collapseInstance.hide();
                    }
                }
            });
          });
        
        // Quick Action Links Listener
        document.querySelectorAll('.quick-action').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const action = link.getAttribute('data-action');
                const modalSelector = modalMap[action];
                if (modalSelector) {
                    const modal = new bootstrap.Modal(document.querySelector(modalSelector));
                    modal.show();
                }
            });
        });

        // Form Submission Listeners
        document.getElementById('transactionForm').addEventListener('submit', (e) => handleFormSubmission(e, 'Transactions', 'TR'));
        document.getElementById('editTransactionForm').addEventListener('submit', handleEditTransactionSubmit);
        document.getElementById('creditCardForm').addEventListener('submit', (e) => handleFormSubmission(e, 'Credit_Cards', 'CARD'));
        document.getElementById('goalForm').addEventListener('submit', (e) => handleFormSubmission(e, 'Goals', 'GOAL'));
        document.getElementById('reminderForm').addEventListener('submit', (e) => handleFormSubmission(e, 'Reminders', 'REM'));
        
        // Conditional fields for Transaction Form
        const transMethod = document.getElementById('trans-method');
        const transCategory = document.getElementById('trans-category');
        const transAccountGroup = document.getElementById('trans-account-group');
        const transRelatedGroup = document.getElementById('trans-related-group');
        
        function toggleTransactionFields() {
            transAccountGroup.style.display = transMethod.value === 'Credit Card' ? 'block' : 'none';
            transRelatedGroup.style.display = transCategory.value === 'Savings Deposit' ? 'block' : 'none';
        }
        
        transMethod.addEventListener('change', toggleTransactionFields);
        transCategory.addEventListener('change', toggleTransactionFields);
        toggleTransactionFields(); // Initial check
        
        // Transaction Filter Listeners
        document.getElementById('filter-type').addEventListener('change', applyTransactionFilters);
        document.getElementById('filter-category').addEventListener('change', applyTransactionFilters);
        document.getElementById('filter-start-date').addEventListener('change', applyTransactionFilters);
        document.getElementById('filter-end-date').addEventListener('change', applyTransactionFilters);
        
        // Load the initial dashboard view
        switchTab('dashboard');
    });
</script>
